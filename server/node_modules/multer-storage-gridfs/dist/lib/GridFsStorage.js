'use strict';var _extends=Object.assign||function(a){for(var c,b=1;b<arguments.length;b++)for(var d in c=arguments[b],c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d]);return a},_GridFsStorageConfig=require('./utils/GridFsStorageConfig'),_GridFsStorageConfig2=_interopRequireDefault(_GridFsStorageConfig),_gridfsStream=require('gridfs-stream'),_gridfsStream2=_interopRequireDefault(_gridfsStream),_mongoose=require('mongoose'),_mongoose2=_interopRequireDefault(_mongoose);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var connection=_mongoose2.default.connection,gridFs;connection.once('open',function(){return gridFs=(0,_gridfsStream2.default)(connection.db,_mongoose2.default.mongo)});var GridFsStorage=function a(){var c=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};_classCallCheck(this,a),this._handleFile=function(d,e,f){c.getDestination(d,e).then(function(){c.getFileName(d,e).then(function(g){var h=_extends({},c.streamOptions,{filename:g}),j=gridFs.createWriteStream(h);e.stream.pipe(j),j.on('error',f).on('close',function(k){return f(null,k)})})})},this._removeFile=function(d,e,f){gridFs.exist({_id:e._id},function(g,h){g&&f(g),h&&gridFs.remove({_id:e._id},function(j){return j?f(j):f(null,e._id)})})},this.getDestination=_GridFsStorageConfig2.default.getDestination,this.getFileName=b.getFilename||_GridFsStorageConfig2.default.getFilename,this.streamOptions=b.streamOptions||_GridFsStorageConfig2.default.streamOptions};exports.default=GridFsStorage;